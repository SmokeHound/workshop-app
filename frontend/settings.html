<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Site Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="assets/styles.css" rel="stylesheet" />
</head>
<body>
  <div id="nav-placeholder"></div>
  <main class="container main-content" style="max-width: 600px;">
    <h1>Site Settings</h1>
    <form id="settings-form" class="card p-4 shadow-sm bg-white">
      <div class="mb-3">
        <label for="theme" class="form-label">Theme</label>
        <select id="theme" class="form-select">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="apiBase" class="form-label">API Base URL</label>
        <input type="text" id="apiBase" class="form-control" />
      </div>
      <div class="mb-3">
        <label for="notifications" class="form-label">Enable Notifications</label>
        <select id="notifications" class="form-select">
          <option value="on">On</option>
          <option value="off">Off</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="defaultPage" class="form-label">Default Page After Login</label>
        <select id="defaultPage" class="form-select">
          <option value="index.html">Home</option>
          <option value="order.html">Order</option>
          <option value="history.html">History</option>
          <option value="item-admin.html">Item Admin</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="fontSize" class="form-label">Font Size</label>
        <select id="fontSize" class="form-select">
          <option value="small">Small</option>
          <option value="medium">Medium</option>
          <option value="large">Large</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="accessibility" class="form-label">Accessibility Options</label>
        <select id="accessibility" class="form-select">
          <option value="normal">Normal</option>
          <option value="high-contrast">High Contrast</option>
        </select>
      </div>
      <button class="btn btn-primary" type="submit">Save Settings</button>
    </form>
    <div id="settings-result" class="mt-3 text-success fw-bold" style="display:none;"></div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { showToast, fetchWithAuth, requireAuth, getCurrentUser } from './utils.js';
    import { API_BASE_URL } from '../shared/config.js';
    
    // Require authentication
    if (!requireAuth()) {
      return;
    }

    // Load saved settings from backend
    const themeSelect = document.getElementById('theme');
    const apiBaseInput = document.getElementById('apiBase');
    const notificationsSelect = document.getElementById('notifications');
    const defaultPageSelect = document.getElementById('defaultPage');
    const fontSizeSelect = document.getElementById('fontSize');
    const accessibilitySelect = document.getElementById('accessibility');
    const resultEl = document.getElementById('settings-result');

    let currentSettings = {};

    // Load settings from backend
    async function loadSettings() {
      try {
        const response = await fetchWithAuth(`${API_BASE_URL}/settings`);
        const data = await response.json();
        currentSettings = data;

        // Update form with backend settings
        themeSelect.value = data.theme || 'light';
        apiBaseInput.value = data.api_base || '';
        notificationsSelect.value = data.notifications || 'on';
        defaultPageSelect.value = data.default_page || 'index.html';
        fontSizeSelect.value = data.font_size || 'medium';
        accessibilitySelect.value = data.accessibility || 'normal';

        // Apply current settings
        applySettingsImmediately();
      } catch (error) {
        console.error('Failed to load settings:', error);
        showToast('Failed to load settings', 'error');
        
        // Fallback to localStorage if backend fails
        loadFromLocalStorage();
      }
    }

    // Fallback to localStorage
    function loadFromLocalStorage() {
      themeSelect.value = localStorage.getItem('siteTheme') || 'light';
      apiBaseInput.value = localStorage.getItem('API_BASE') || '';
      notificationsSelect.value = localStorage.getItem('notifications') || 'on';
      defaultPageSelect.value = localStorage.getItem('defaultPage') || 'index.html';
      fontSizeSelect.value = localStorage.getItem('fontSize') || 'medium';
      accessibilitySelect.value = localStorage.getItem('accessibility') || 'normal';
    }

    // Apply settings immediately for preview
    function applySettingsImmediately() {
      document.documentElement.setAttribute('data-theme', themeSelect.value);
      document.body.style.fontSize = fontSizeSelect.value === 'small' ? '14px' : 
                                     fontSizeSelect.value === 'large' ? '20px' : '16px';
      if (accessibilitySelect.value === 'high-contrast') {
        document.body.classList.add('high-contrast');
      } else {
        document.body.classList.remove('high-contrast');
      }
    }

    // Save settings to backend
    document.getElementById('settings-form').onsubmit = async (e) => {
      e.preventDefault();
      
      const settings = {
        theme: themeSelect.value,
        api_base: apiBaseInput.value.trim(),
        notifications: notificationsSelect.value,
        default_page: defaultPageSelect.value,
        font_size: fontSizeSelect.value,
        accessibility: accessibilitySelect.value
      };

      try {
        const response = await fetchWithAuth(`${API_BASE_URL}/settings`, {
          method: 'PUT',
          body: JSON.stringify(settings)
        });

        const data = await response.json();
        currentSettings = settings;

        // Also save to localStorage as backup
        localStorage.setItem('siteTheme', settings.theme);
        localStorage.setItem('API_BASE', settings.api_base);
        localStorage.setItem('notifications', settings.notifications);
        localStorage.setItem('defaultPage', settings.default_page);
        localStorage.setItem('fontSize', settings.font_size);
        localStorage.setItem('accessibility', settings.accessibility);

        resultEl.textContent = 'Settings saved successfully!';
        resultEl.className = 'mt-3 alert alert-success';
        resultEl.style.display = 'block';
        showToast('Settings updated successfully!', 'success');
        
        setTimeout(() => resultEl.style.display = 'none', 3000);
        applySettingsImmediately();
      } catch (error) {
        console.error('Failed to save settings:', error);
        resultEl.textContent = 'Failed to save settings: ' + error.message;
        resultEl.className = 'mt-3 alert alert-danger';
        resultEl.style.display = 'block';
        showToast('Failed to save settings', 'error');
      }
    };

    // Apply theme and font size immediately on change for preview
    themeSelect.onchange = applySettingsImmediately;
    fontSizeSelect.onchange = applySettingsImmediately;
    accessibilitySelect.onchange = applySettingsImmediately;

    // Nav loader script
    async function loadNav() {
      try {
        const res = await fetch('nav.html');
        if (!res.ok) {
          throw new Error(`Failed to load nav.html: ${res.status} ${res.statusText}`);
        }
        const html = await res.text();
        const navPlaceholder = document.getElementById('nav-placeholder');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        navPlaceholder.replaceChildren(...tempDiv.childNodes);
        
        // Show user info in nav
        const user = getCurrentUser();
        const userInfo = document.querySelector('.user-info');
        if (userInfo) {
          userInfo.textContent = `${user.username} (${user.role})`;
        }
      } catch (err) {
        console.error('Failed to load nav:', err);
        showToast('Failed to load navigation.', 'error');
      }
    }

    // Initialize
    if (document.readyState === 'loading') {
      window.addEventListener('DOMContentLoaded', () => {
        loadNav();
        loadSettings();
      }, { once: true });
    } else {
      loadNav();
      loadSettings();
    }
  </script>
</body>
</html>
