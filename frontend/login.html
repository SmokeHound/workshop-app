<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Workshop App ‚Äì Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="assets/styles.css" rel="stylesheet" />
</head>
<body>
  <div id="nav-placeholder"></div>

  <main class="container-fluid main-content" style="max-width: 500px;">
    <h1>üîê Login</h1>
    <form id="login-form">
      <div class="mb-3">
        <label for="username" class="form-label">Username</label>
        <input type="text" id="username" class="form-control" required autocomplete="username" />
        <div class="invalid-feedback"></div>
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input type="password" id="password" class="form-control" required autocomplete="current-password" />
        <div class="invalid-feedback"></div>
      </div>
      <button type="submit" class="btn btn-primary w-100" id="login-btn">Login</button>
    </form>
    <div id="login-result" class="mt-3" style="display:none;"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initThemeToggle, showToast } from './utils.js';
    import { API_BASE_URL } from '../shared/config.js';

    async function loadNav() {
      const res = await fetch('nav.html');
      const html = await res.text();
      const navPlaceholder = document.getElementById('nav-placeholder');
      navPlaceholder.textContent = '';
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      Array.from(tempDiv.childNodes).forEach(node => navPlaceholder.appendChild(node));
      initThemeToggle('themeToggle');

      const currentPage = location.pathname.split('/').pop();
      document.querySelectorAll('[data-page]').forEach(link => {
        const icon = link.querySelector('i');
        if (link.getAttribute('data-page') === currentPage) {
          link.classList.add('active');
          if (icon) icon.classList.add('text-light');
        } else {
          link.classList.remove('active');
          if (icon) icon.classList.remove('text-light');
        }
      });
    }

    // Check if already logged in
    if (localStorage.getItem('authToken')) {
      window.location.href = localStorage.getItem('defaultPage') || 'index.html';
    }

    // Login form submission
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const resultEl = document.getElementById('login-result');
      const loginBtn = document.getElementById('login-btn');
      
      if (!username || !password) {
        showToast('Please enter both username and password', 'error');
        return;
      }

      // Show loading state
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      resultEl.style.display = 'none';

      try {
        const response = await fetch(`${API_BASE_URL}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });

        const data = await response.json();

        if (response.ok) {
          // Store auth info
          localStorage.setItem('authToken', data.token);
          localStorage.setItem('username', data.user);
          localStorage.setItem('userRole', data.role);
          
          showToast('Login successful!', 'success');
          
          // Redirect to default page
          const defaultPage = localStorage.getItem('defaultPage') || 'index.html';
          setTimeout(() => {
            window.location.href = defaultPage;
          }, 1000);
        } else {
          // Show error
          resultEl.className = 'mt-3 alert alert-danger';
          resultEl.textContent = data.error || 'Login failed';
          resultEl.style.display = 'block';
          showToast(data.error || 'Login failed', 'error');
        }
      } catch (error) {
        console.error('Login error:', error);
        resultEl.className = 'mt-3 alert alert-danger';
        resultEl.textContent = 'Network error. Please try again.';
        resultEl.style.display = 'block';
        showToast('Network error. Please try again.', 'error');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    });

    document.addEventListener('DOMContentLoaded', loadNav);
  </script>
</body>
</html>
