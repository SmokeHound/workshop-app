<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="assets/styles.css" rel="stylesheet" />
</head>
<body>
  <div id="nav-placeholder"></div>
  <main class="container" style="margin-left: 270px; padding-top: 20px; max-width: 900px;">
    <h1>Admin Tools</h1>
    <section class="mb-4">
      <h2 class="h5">Bulk Import/Export Users</h2>
      <form id="import-form" class="d-flex gap-2 mb-2">
        <input type="file" id="importFile" accept=".csv,.json" class="form-control" />
        <button class="btn btn-primary" type="submit">Import</button>
      </form>
      <button class="btn btn-outline-secondary" id="exportBtn">Export Users (CSV)</button>
    </section>
    <section class="mb-4">
      <h2 class="h5">Role-Based Access Control</h2>
      <div id="role-access-list"></div>
    </section>
    <section class="mb-4">
      <h2 class="h5">System Logs</h2>
      <button class="btn btn-outline-info mb-2" id="refreshLogs">Refresh Logs</button>
      <pre id="system-logs" style="background:#222;color:#eee;padding:1em;max-height:300px;overflow:auto;"></pre>
    </section>
    <section class="mb-4">
      <h2 class="h5">Site Announcements</h2>
      <form id="announcement-form" class="d-flex gap-2 mb-2">
        <input type="text" id="announcementText" class="form-control" placeholder="Announcement..." />
        <button class="btn btn-success" type="submit">Post</button>
      </form>
      <ul id="announcement-list" class="list-group"></ul>
    </section>
    <section class="mb-4">
      <h2 class="h5">Session Management</h2>
      <button class="btn btn-outline-warning mb-2" id="refreshSessions">Refresh Sessions</button>
      <div id="session-list" class="list-group"></div>
    </section>
    <section class="mb-4">
      <h2 class="h5">API Key Management</h2>
      <form id="api-key-form" class="d-flex gap-2 mb-2">
        <input type="text" id="apiKeyName" class="form-control" placeholder="Key name..." />
        <button class="btn btn-primary" type="submit">Generate</button>
      </form>
      <ul id="api-key-list" class="list-group"></ul>
    </section>
    <section class="mb-4">
      <h2 class="h5">Data Backup/Restore</h2>
      <button class="btn btn-outline-secondary mb-2" id="backupBtn">Download Backup</button>
      <form id="restore-form" class="d-flex gap-2">
        <input type="file" id="restoreFile" accept=".json" class="form-control" />
        <button class="btn btn-danger" type="submit">Restore</button>
      </form>
    </section>
    <div id="admin-result" class="mt-3 text-success fw-bold" style="display:none;"></div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { showToast } from './utils.js';
    import { API_BASE_URL } from '../shared/config.js';
    // Load nav
    async function loadNav() {
      const res = await fetch('nav.html');
      const html = await res.text();
      document.getElementById('nav-placeholder').innerHTML = html;
    }
    document.addEventListener('DOMContentLoaded', loadNav);
    // Bulk import/export users
    document.getElementById('import-form').onsubmit = async e => {
      e.preventDefault();
      const file = document.getElementById('importFile').files[0];
      if (!file) return showToast('No file selected.', 'error');
      const text = await file.text();
      let users;
      try {
        users = JSON.parse(text);
      } catch {
        showToast('Invalid file format.', 'error');
        return;
      }
      const res = await fetch(`${API_BASE_URL}/admin/users/import`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ users })
      });
      if (res.ok) {
        showToast('Users imported.', 'success');
      } else {
        showToast('Import failed.', 'error');
      }
    };
    document.getElementById('exportBtn').onclick = async () => {
      const res = await fetch(`${API_BASE_URL}/admin/users/export`);
      if (!res.ok) return showToast('Export failed.', 'error');
      const users = await res.json();
      const blob = new Blob([JSON.stringify(users, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'users.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Users exported.', 'success');
    };
    // Role-based access control
    async function renderRoleAccess() {
      const res = await fetch(`${API_BASE_URL}/admin/roles`);
      const rolesObj = await res.json();
      const roles = Object.keys(rolesObj);
      const pages = ['Home', 'Order', 'History', 'Item Admin', 'User Management', 'Admin Tools'];
      const container = document.getElementById('role-access-list');
      container.innerHTML = '<table class="table table-bordered"><thead><tr><th>Role</th>' +
        pages.map(p => `<th>${p}</th>`).join('') + '</tr></thead><tbody>' +
        roles.map(role => `<tr><td>${role}</td>` +
          pages.map(page => `<td><input type="checkbox" ${rolesObj[role].includes('*') || rolesObj[role].includes(page) ? 'checked' : ''} data-role="${role}" data-page="${page}"></td>`).join('') + '</tr>').join('') + '</tbody></table>';
      container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.onchange = async () => {
          // Collect new roles
          const newRoles = {};
          roles.forEach(r => {
            newRoles[r] = [];
            pages.forEach(p => {
              const box = container.querySelector(`input[data-role="${r}"][data-page="${p}"]`);
              if (box && box.checked) newRoles[r].push(p);
            });
          });
          await fetch(`${API_BASE_URL}/admin/roles`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newRoles)
          });
          showToast('Roles updated.', 'success');
        };
      });
    }
    renderRoleAccess();
    // System logs
    document.getElementById('refreshLogs').onclick = async () => {
      document.getElementById('system-logs').textContent = 'Fetching logs...';
      const res = await fetch(`${API_BASE_URL}/admin/logs`);
      if (!res.ok) return showToast('Failed to fetch logs.', 'error');
      const logs = await res.json();
      document.getElementById('system-logs').textContent = logs.join('\n');
    };
    // Announcements
    async function loadAnnouncements() {
      const res = await fetch(`${API_BASE_URL}/admin/announcements`);
      const list = document.getElementById('announcement-list');
      list.innerHTML = '';
      if (!res.ok) return;
      const anns = await res.json();
      anns.forEach(a => {
        const item = document.createElement('li');
        item.className = 'list-group-item d-flex justify-content-between';
        item.innerHTML = `<span>${a.text}</span><button class="btn btn-sm btn-danger" data-ts="${a.ts}">Remove</button>`;
        list.appendChild(item);
      });
    }
    loadAnnouncements();
    document.getElementById('announcement-form').onsubmit = async e => {
      e.preventDefault();
      const text = document.getElementById('announcementText').value.trim();
      if (!text) return showToast('Announcement required.', 'error');
      const res = await fetch(`${API_BASE_URL}/admin/announcements`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });
      if (res.ok) {
        showToast('Announcement posted.', 'success');
        document.getElementById('announcementText').value = '';
        loadAnnouncements();
      } else {
        showToast('Failed to post announcement.', 'error');
      }
    };
    document.getElementById('announcement-list').onclick = async e => {
      if (e.target.classList.contains('btn-danger')) {
        const ts = e.target.getAttribute('data-ts');
        const res = await fetch(`${API_BASE_URL}/admin/announcements/${ts}`, { method: 'DELETE' });
        if (res.ok) {
          showToast('Announcement removed.', 'success');
          loadAnnouncements();
        } else {
          showToast('Failed to remove announcement.', 'error');
        }
      }
    };
    // Session management
    document.getElementById('refreshSessions').onclick = async () => {
      const list = document.getElementById('session-list');
      list.innerHTML = '';
      const res = await fetch(`${API_BASE_URL}/admin/sessions`);
      if (!res.ok) return showToast('Failed to fetch sessions.', 'error');
      const sessions = await res.json();
      sessions.forEach(s => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between';
        item.innerHTML = `<span>${s.username}</span><button class="btn btn-sm btn-danger" data-id="${s.id}">Revoke</button>`;
        list.appendChild(item);
      });
    };
    document.getElementById('session-list').onclick = async e => {
      if (e.target.classList.contains('btn-danger')) {
        const id = e.target.getAttribute('data-id');
        const res = await fetch(`${API_BASE_URL}/admin/sessions/${id}`, { method: 'DELETE' });
        if (res.ok) {
          showToast('Session revoked.', 'success');
          document.getElementById('refreshSessions').click();
        } else {
          showToast('Failed to revoke session.', 'error');
        }
      }
    };
    // API key management
    async function loadApiKeys() {
      const res = await fetch(`${API_BASE_URL}/admin/apikeys`);
      const list = document.getElementById('api-key-list');
      list.innerHTML = '';
      if (!res.ok) return;
      const keys = await res.json();
      keys.forEach(k => {
        const item = document.createElement('li');
        item.className = 'list-group-item d-flex justify-content-between';
        item.innerHTML = `<span>${k.name} — ${k.key}</span><button class="btn btn-sm btn-danger" data-key="${k.key}">Revoke</button>`;
        list.appendChild(item);
      });
    }
    loadApiKeys();
    document.getElementById('api-key-form').onsubmit = async e => {
      e.preventDefault();
      const name = document.getElementById('apiKeyName').value.trim();
      if (!name) return showToast('Key name required.', 'error');
      const res = await fetch(`${API_BASE_URL}/admin/apikeys`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      if (res.ok) {
        showToast('API key generated.', 'success');
        document.getElementById('apiKeyName').value = '';
        loadApiKeys();
      } else {
        showToast('Failed to generate key.', 'error');
      }
    };
    document.getElementById('api-key-list').onclick = async e => {
      if (e.target.classList.contains('btn-danger')) {
        const key = e.target.getAttribute('data-key');
        const res = await fetch(`${API_BASE_URL}/admin/apikeys/${key}`, { method: 'DELETE' });
        if (res.ok) {
          showToast('API key revoked.', 'success');
          loadApiKeys();
        } else {
          showToast('Failed to revoke key.', 'error');
        }
      }
    };
    // Data backup/restore
    document.getElementById('backupBtn').onclick = async () => {
      const res = await fetch(`${API_BASE_URL}/admin/backup`);
      if (!res.ok) return showToast('Backup failed.', 'error');
      const backup = await res.json();
      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'backup.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Backup downloaded.', 'success');
    };
    document.getElementById('restore-form').onsubmit = async e => {
      e.preventDefault();
      const file = document.getElementById('restoreFile').files[0];
      if (!file) return showToast('No file selected.', 'error');
      const text = await file.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch {
        showToast('Invalid file format.', 'error');
        return;
      }
      const res = await fetch(`${API_BASE_URL}/admin/restore`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (res.ok) {
        showToast('Restore complete.', 'success');
      } else {
        showToast('Restore failed.', 'error');
      }
    };
  </script>
</body>
</html>
